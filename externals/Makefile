POD=pod
XCODEBUILD=/Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild

PROJECT_ROOT=./Pods
PROJECT=$(PROJECT_ROOT)/Pods.xcodeproj
TARGETS=AudioKit

all: Podfile.lock $(TARGETS)

Podfile.lock:
	$(POD) install

$(TARGETS):
	$(MAKE) $@-iphoneos.framework
	$(MAKE) $@-iphonesimulator.framework
	cp -R ./$@-iphoneos.framework $@.framework
	lipo -create -output $@.framework/$@ $@-iphoneos.framework/$@ $@-iphonesimulator.framework/$@

%-iphoneos.framework:
	$(eval currentTarget=$(subst -iphoneos.framework,,$@))
	$(XCODEBUILD) -project $(PROJECT) -target $(currentTarget) -sdk iphoneos -arch armv7 -arch arm64 -configuration Release clean build
	-mv ./build/Release-iphoneos/$(currentTarget)/$(currentTarget).framework $@

%-iphonesimulator.framework:
	$(eval currentTarget=$(subst -iphonesimulator.framework,,$@))
	$(XCODEBUILD) -project $(PROJECT) -target $(currentTarget) -sdk iphonesimulator -arch i386 -arch x86_64 -configuration Release clean build
	-mv ./build/Release-iphonesimulator/$(currentTarget)/$(currentTarget).framework $@

clean:
	@ rm -rf Podfile.lock Pods build
	@ for target in $(TARGETS); do \
        rm -rf $$target*; \
	done

.PHONY: all clean
